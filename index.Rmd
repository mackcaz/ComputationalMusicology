---
title: "ComputationalMusicologyPortfolio"
author: "Mick"
date: "2024-02-12"
output:
  flexdashboard::flex_dashboard:
    storyboard: true
---

```{r, echo=FALSE}
knitr::opts_chunk$set(cache = TRUE)
```

```{r}
  library(tidyverse)
  library(spotifyr)
  library(dplyr)
  library(ggplot2)
  library(flexdashboard)
  library(plotly)
  library(compmus)
```

```{r}
Top50Netherlands <- get_playlist_audio_features("", "37i9dQZEVXbKCF6dqVpDkS")
Top50USA <- get_playlist_audio_features("", "37i9dQZEVXbLRQDuF5jeBp")
Top50Brazil <- get_playlist_audio_features("", "37i9dQZEVXbMXbN3EUUhlg")
Top50Australia <- get_playlist_audio_features("", "37i9dQZEVXbJPcfkRz0wJ0")
Top50Philippines <- get_playlist_audio_features("", "37i9dQZEVXbNBz9cRCSFkY")
Top50Morocco <- get_playlist_audio_features("", "37i9dQZEVXbJU9eQpX8gPT")
Top50UK <- get_playlist_audio_features("", "37i9dQZEVXbLnolsZ8PSNw")
```

### Introduction

The corpus that will be used for this project is the top 50 of multiple countries on Spotify that has an available top 50. This is an interesting corpus because it can show the differences and similarities between popular music in many different places across the world. The comparison points can be either countries, regions, or continents. This flexibility is another advantage of the corpus. The limitations of this corpus are the fact that recent releases or events can influence music worldwide and can push music to the top of many top 50 lists while not saying much about the differences between places (such as the recent release of Kanye West having multiple songs in multiple different top 50 lists). Another limitation is the fact that multiple countries might not use Spotify as their main source of music, so this could influence regional trends in a way that makes them not representative of the population of the country as a whole. A final weakness is the fact that this corpus changes daily, so it can be hard to look into individual tracks since they will probably be gone after a certain time. Finally, it is difficult to pick specific interesting tracks in this corpus due to the sheer number of tracks (3600) in it. But some that may be interesting at first glance are CARNIVAL (Kanye West), Cruel Summer (Taylor Swift), Unwritten (Natasha Bedingfield) and I Wanna Be Yours (Arctic Monkeys). This Kanye West song and many others of his (very) recent album are interesting because they can be found in nearly every top 50 list. The other three songs are mostly interesting because they are older songs that are still found in multiple top 50 lists across the corpus.

### Are all popular songs happy and energetic?

```{r}
Top50s <-
  bind_rows(
    mutate(Top50Netherlands, category = "Top50Netherlands"),
    mutate(Top50USA, category = "Top50USA"),
    mutate(Top50Brazil, category = "Top50Brazil"),
    mutate(Top50Australia, category = "Top50Australia"),
    mutate(Top50Philippines, category = "Top50Philippines"),
    mutate(Top50Morocco, category = "Top50Morocco"),
    mutate(Top50UK, category = "Top50UK")
  )
```

```{r}
country_colors <- c("Top50USA" = "#b22222", "Top50Australia" = "#006400", "Top50Brazil" = "#ffd700", 
                    "Top50Netherlands" = "#ff4500", "Top50Philippines" = "#0000ff", "Top50Morocco" = "#8b0000", "Top50UK" = "#000080")
```


```{r}
# Create the ggplot and save it as a variable
my_plot <- Top50s %>% 
  ggplot(aes(x = energy, y = valence)) + 
  geom_jitter(aes(color = category)) + 
  geom_smooth() + 
  scale_color_manual(values = country_colors)

# Render the ggplot using ggplotly
ggplotly(my_plot)
```

***

The first plot shows the relation between energy and valence in music from all the different top 50s, it also shows which top 50 every datapoint is from using colors typically associated with the countries that are used. It shows that energy and valence are correlated, but not as much as you might expect. It also shows some regional trends.

### Differences between Pop Music in Different Regions

```{r}
# Function to capitalize the first letter of a string
capitalize_first <- function(x) {
  paste(tools::toTitleCase(x), collapse = " ")
}

# Function to generate violin plot for any feature
plot_feature <- function(data, feature) {
  feature_str <- capitalize_first(deparse(substitute(feature)))  # Capitalize the first letter of the feature
  
  # Calculate the average feature value for each country
  avg_feature <- data %>%
    group_by(category) %>%
    summarise(avg_value = mean({{ feature }})) %>%
    arrange(desc(avg_value))  # Order by average feature value from high to low
  
  # Create the violin plot
  ggplot(data, aes(x = reorder(category, -{{ feature }}), y = {{ feature }}, fill = category)) +
    geom_violin(trim = FALSE) +
    geom_boxplot(width = 0.1, outlier.shape = NA, fill = "white", color = "black", alpha = 0.5) +
    scale_fill_manual(values = country_colors) +
    theme_minimal() +
    labs(
      title = paste("Distribution of", feature_str, "Levels Across Playlists"),
      x = "Playlist",
      y = paste(feature_str, "Level"),
      fill = "Country"
    ) +
    theme(
      legend.position = "none",
      plot.title = element_text(hjust = 0.5),
      axis.text.x = element_text(angle = 45, hjust = 1)
    )
}


```

```{r}
# plot acousticness
plot_feature(Top50s, acousticness)

# plot danceability
plot_feature(Top50s, danceability)

# plot energy
plot_feature(Top50s, energy)

# plot liveness
plot_feature(Top50s, liveness)

# plot loudness
plot_feature(Top50s, loudness)

# plot speechiness
plot_feature(Top50s, speechiness)

# plot tempo
plot_feature(Top50s, tempo)

# plot valence
plot_feature(Top50s, valence)
```

***

There are a bunch of violin plots that show the distribution of different Spotify statistics sorted from the highest mean to the lowest mean. This shows a lot about the differences between countries (and continents potentially).

### Chroma analysis of an outlier

```{r}
outlier <-
  get_tidy_audio_analysis("1BxfuPKGuaTgP7aM0Bbdwr") %>% 
  select(segments) %>% 
  unnest(segments) %>% 
  select(start, duration, pitches)

outlier %>% 
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>% 
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()
```

***

This is a chroma graph of an outlier in the dataset: "Cruel Summer" by Taylor Swift, which is one of the oldest songs which is found in multiple top 50 lists.

### Structure similarity matrix of an outlier

```{r}
bzt <-
  get_tidy_audio_analysis("1BxfuPKGuaTgP7aM0Bbdwr") %>%
  compmus_align(bars, segments) %>%
  select(bars) %>%
  unnest(bars) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "acentre", norm = "manhattan"
      )
  ) %>%
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "mean"
      )
  )
bind_rows(
  bzt %>%
    compmus_self_similarity(pitches, "aitchison") %>%
    mutate(d = d / max(d), type = "Chroma"),
  bzt %>% 
    compmus_self_similarity(timbre, "euclidean") %>% 
    mutate(d = d / max(d), type = "Timbre")
) %>%
  mutate() %>% 
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  facet_wrap(~type) +
  scale_fill_viridis_c(option = "E", guide = "none") +
  theme_classic() + 
  labs(x = "", y = "")
```

***

These are two self similarity matrices of  "Cruel Summer" by Taylor Swift, these similarity matrices show both Chroma and Timbre.